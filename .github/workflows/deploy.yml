name: Deploy to MilesWeb
on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          passphrase: ${{ secrets.SERVER_SSH_PASSPHRASE }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script_stop: true
          script: |
            # Navigate to app directory
            cd /home/jyddjslu/repositories/hotelEleganceApp

            # Reset local changes and remove untracked files
            git reset --hard
            git clean -fd

            # Pull latest code
            git pull origin main

            # Install dependencies (using ci for cleaner installs)
            npm ci

            # ğŸ”§ FIX FOR 404 ASSETS: Create symbolic link for assets
            echo "ğŸ”— Creating symbolic link for assets to fix 404 errors..."
            # Remove old symlink if exists
            rm -f /home/jyddjslu/repositories/hotelEleganceApp/assets
            # Create new symlink from public/assets to root assets
            ln -sf /home/jyddjslu/repositories/hotelEleganceApp/public/assets /home/jyddjslu/repositories/hotelEleganceApp/assets
            
            # Verify the symlink was created
            echo "âœ… Symlink created:"
            ls -la /home/jyddjslu/repositories/hotelEleganceApp/assets | head -5

            # Build Next.js app for production
            echo "ğŸ—ï¸ Building Next.js app..."
            npm run build

            # ğŸ›¡ï¸ Additional fix: Create assets folder in .next if needed for standalone
            if [ -d ".next/standalone" ]; then
              echo "ğŸ“ Setting up assets in standalone mode..."
              mkdir -p .next/standalone/public
              cp -r public/* .next/standalone/public/ 2>/dev/null || echo "No public files to copy"
              # Create symlink in standalone as well
              ln -sf /home/jyddjslu/repositories/hotelEleganceApp/public/assets .next/standalone/assets 2>/dev/null || echo "Symlink in standalone"
            fi

            # ğŸ”§ Fix permissions to ensure files are readable
            echo "ğŸ”§ Fixing file permissions..."
            find public -type d -exec chmod 755 {} \;
            find public -type f -exec chmod 644 {} \;
            
            # If assets symlink exists, ensure its permissions
            if [ -L "assets" ]; then
              chmod 755 public/assets
            fi

            # Ensure tmp folder exists and restart file is touched
            mkdir -p tmp
            touch tmp/restart.txt

            # ğŸ¥ Optional: Test if assets are now accessible
            echo "ğŸ¥ Testing asset accessibility..."
            if [ -f "public/assets/css/style.css" ]; then
              echo "âœ… CSS files found in public/assets/css/"
              ls -la public/assets/css/ | head -10
            else
              echo "âš ï¸ Warning: CSS files not found in public/assets/css/"
            fi

            # Log deployed time
            echo "âœ… Deployment completed at $(date)"